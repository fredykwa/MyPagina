<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profe Digital Kwa - Plataforma Educativa Interactiva</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover, .card-hover:focus-within { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .animation-card { background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; }
        .section-hidden { display: none; }
        .lesson-tab { cursor: pointer; padding: 0.75rem 1.25rem; border-bottom: 3px solid transparent; font-weight: 600; color: #6b7280; }
        .lesson-tab:hover { color: #111827; }
        .lesson-tab.active { color: #4f46e5; border-bottom-color: #4f46e5; }
        .lesson-content { display: none; }
        .lesson-content.active { display: block; }
        #adminPanel form button[type="submit"]:disabled { background-color: #9ca3af; cursor: not-allowed;}
        /* Estilo para indicar carga */
        .loading-overlay { position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Overlay de Carga -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;"> <!-- Oculto por defecto -->
        <div class="loading-spinner"></div>
        <p class="ml-4 text-gray-700 font-semibold">Cargando datos...</p>
    </div>

    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="showSection('inicio')">
                    <div class="bg-white bg-opacity-20 p-2 rounded-lg"><span class="text-2xl">üìö</span></div>
                    <div><h1 class="text-2xl font-bold">Profe Digital Kwa</h1><p class="text-sm opacity-90">Plataforma Educativa Interactiva</p></div>
                </div>
                <nav class="hidden md:flex space-x-6 items-center">
                    <a href="#" onclick="event.preventDefault(); showSection('inicio')" class="hover:text-blue-200 transition-colors">Inicio</a>
                    <a href="#" onclick="event.preventDefault(); showSection('matematicas')" class="hover:text-blue-200 transition-colors">Matem√°ticas</a>
                    <a href="#" onclick="event.preventDefault(); showSection('fisica')" class="hover:text-blue-200 transition-colors">F√≠sica</a>
                    <a href="#" onclick="event.preventDefault(); showSection('animaciones')" class="bg-white bg-opacity-20 px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">Todas las Animaciones</a>
                </nav>
                <button class="md:hidden text-white" onclick="toggleMobileMenu()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
            </div>
            <div id="mobileMenu" class="hidden md:hidden mt-4 pb-4">
                <a href="#" onclick="event.preventDefault(); showSection('inicio')" class="block py-2 hover:text-blue-200">Inicio</a>
                <a href="#" onclick="event.preventDefault(); showSection('matematicas')" class="block py-2 hover:text-blue-200">Matem√°ticas</a>
                <a href="#" onclick="event.preventDefault(); showSection('fisica')" class="block py-2 hover:text-blue-200">F√≠sica</a>
                <a href="#" onclick="event.preventDefault(); showSection('animaciones')" class="block py-2 hover:text-blue-200">Todas las Animaciones</a>
            </div>
        </div>
    </header>
    <!-- Breadcrumb -->
    <nav id="breadcrumb" class="container mx-auto px-6 py-4" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center"><a href="#" onclick="event.preventDefault(); showSection('inicio')" class="text-gray-700 hover:text-blue-600">üè† Inicio</a></li>
            <li id="breadcrumbSection" class="hidden"><div class="flex items-center"><svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg><span id="breadcrumbText" class="ml-1 text-gray-500 md:ml-2"></span></div></li>
        </ol>
    </nav>
    <!-- Main Content -->
    <main class="container mx-auto px-6 pb-8">
        <section id="inicio" class="section"></section>
        <section id="matematicas" class="section section-hidden"></section>
        <section id="fisica" class="section section-hidden"></section>
        <section id="animaciones" class="section section-hidden"></section>
        <section id="animationDetail" class="section section-hidden"><div id="animationContent"></div></section>
    </main>
    <!-- Admin Panel Toggle -->
    <div id="adminToggle" class="fixed bottom-6 right-6 z-50"><button onclick="toggleAdminPanel()" class="bg-gray-800 hover:bg-gray-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 transform hover:scale-110" title="Panel de Administraci√≥n">üîë</button></div>
    <!-- Admin Panel Modal -->
    <div id="adminPanel" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col">
                <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-6 rounded-t-xl sticky top-0 z-10 flex-shrink-0"><div class="flex items-center justify-between"><div class="flex items-center space-x-3"><div class="bg-white bg-opacity-20 p-2 rounded-lg">üîë</div><div><h2 class="text-2xl font-bold">Panel de Administraci√≥n</h2><p class="text-gray-300">Gestiona contenido y animaciones (Firebase)</p></div></div><button onclick="toggleAdminPanel()" class="text-white hover:text-gray-300 text-2xl">‚úï</button></div></div>
                <div class="p-6 overflow-y-auto flex-grow">
                    <div class="flex border-b border-gray-200 mb-6"><button onclick="showAdminTab('animations', event)" class="admin-tab-btn px-6 py-3 font-semibold text-blue-600 border-b-2 border-blue-600">üé¨ Gestionar Animaciones</button></div>
                    <div id="adminAnimations" class="admin-tab-content">
                        <div class="mb-6"><h3 class="text-xl font-bold mb-4">Agregar/Editar Animaci√≥n</h3><form id="addAnimationForm" class="space-y-4"><input type="hidden" id="animationId"><div class="grid md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo</label><input type="text" id="animationTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ej: Teorema de Pit√°goras" required></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Materia</label><select id="animationSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"><option value="matematicas">üìê Matem√°ticas</option><option value="fisica">üî¨ F√≠sica</option><option value="quimica">‚öóÔ∏è Qu√≠mica</option></select></div></div><div><label class="block text-sm font-medium text-gray-700 mb-2">URL de la Animaci√≥n (iframe)</label><input type="url" id="animationUrl" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="https://fredykwa.github.io/..." required></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n Breve (para la tarjeta)</label><textarea id="animationDescription" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Descripci√≥n breve de la animaci√≥n" required></textarea></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Palabras Clave (separadas por espacios)</label><input type="text" id="animationKeywords" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="geometr√≠a tri√°ngulos teorema pit√°goras"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Objetivos de Aprendizaje (uno por l√≠nea)</label><textarea id="animationObjectives" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Comprender el teorema de Pit√°goras&#10;Aplicar la f√≥rmula en problemas"></textarea></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Controles Interactivos (uno por l√≠nea)</label><textarea id="animationControls" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ajusta los lados del tri√°ngulo&#10;Observa c√≥mo cambia la hipotenusa"></textarea></div><div class="border-t border-gray-200 pt-4"><label class="block text-sm font-medium text-gray-700 mb-2">Explicaci√≥n Te√≥rica (Acepta HTML)</label><textarea id="animationTheory" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="<p>Una fracci√≥n es un n√∫mero que...</p><ul><li>Numerador</li>...</ul>"></textarea></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Ejemplos Resueltos (Acepta HTML)</label><textarea id="animationExamples" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="<h4>Ejemplo 1:</h4><p>Si tenemos 3/4...</p>"></textarea></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Desaf√≠o (Acepta HTML)</label><textarea id="animationChallenge" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="<h4>¬°Ponte a prueba!</h4><p>¬øQu√© fracci√≥n es mayor, 2/3 o 5/6?</p>"></textarea></div><div class="flex space-x-4"><button type="submit" id="formSubmitButton" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">‚ûï Agregar Animaci√≥n</button><button type="button" id="formCancelButton" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors hidden" onclick="resetAdminForm()">Cancelar Edici√≥n</button></div></form></div>
                        <div class="border-t pt-6"><h3 class="text-xl font-bold mb-4">Animaciones Existentes (Firestore)</h3><div id="existingAnimations" class="space-y-4">Cargando...</div></div>
                    </div>
                    <!-- Pesta√±as de Content y Settings removidas temporalmente para simplificar -->
                </div>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-16">
        <div class="container mx-auto px-6 py-8">
            <div class="grid md:grid-cols-4 gap-8">
                <div><h4 class="text-lg font-semibold mb-4">Profe Digital Kwa</h4><p class="text-gray-400">Plataforma educativa interactiva para el aprendizaje de matem√°ticas y ciencias.</p></div>
                <div><h4 class="text-lg font-semibold mb-4">Materias</h4><ul class="space-y-2 text-gray-400"><li><a href="#" onclick="event.preventDefault(); showSection('matematicas')" class="hover:text-white">Matem√°ticas</a></li><li><a href="#" onclick="event.preventDefault(); showSection('fisica')" class="hover:text-white">F√≠sica</a></li><li><a href="#" class="hover:text-white">Qu√≠mica</a></li></ul></div>
                <div><h4 class="text-lg font-semibold mb-4">Recursos</h4><ul class="space-y-2 text-gray-400"><li><a href="#" onclick="event.preventDefault(); showSection('animaciones')" class="hover:text-white">Animaciones</a></li><li><a href="#" class="hover:text-white">Simuladores</a></li><li><a href="#" class="hover:text-white">Ejercicios</a></li></ul></div>
                <div><h4 class="text-lg font-semibold mb-4">Contacto</h4><ul id="footerContact" class="space-y-2 text-gray-400"><li>üìß info@eduhub.com</li><li>üì± +1 234 567 8900</li></ul></div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400"><p>&copy; 2024 Profe Digital Kwa. Todos los derechos reservados.</p></div>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        console.log("SCRIPT MODULE START: Iniciando script de m√≥dulo.");
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, setDoc, deleteDoc, query, orderBy, enableNetwork, disableNetwork } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- Funci√≥n movida al principio ---
        function showLoadingOverlay(show, message = "Cargando...") {
            const overlay = document.getElementById('loadingOverlay');
            if (!overlay) { console.error("showLoadingOverlay: Elemento loadingOverlay no encontrado."); return; }
            const msgElement = overlay.querySelector('p');
            if (msgElement) msgElement.textContent = message;
            overlay.style.display = show ? 'flex' : 'none';
            console.log(`showLoadingOverlay: ${show ? 'Mostrando' : 'Ocultando'} - ${message}`);
        }

        // CONFIGURACI√ìN DE FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyBS5_0cPqCnbGo_chVNhZ-breB2GZu0OY8",
          authDomain: "profedigitalkwa.firebaseapp.com",
          projectId: "profedigitalkwa",
          storageBucket: "profedigitalkwa.appspot.com",
          messagingSenderId: "1045533291717",
          appId: "1:1045533291717:web:bac69b7e6f880855e6acac",
          measurementId: "G-GTG8N9354N"
        };

        // Initialize Firebase
        let app, db;
        let firebaseInitialized = false; // Flag crucial
        try {
            console.log("Intentando inicializar Firebase...");
            app = initializeApp(firebaseConfig);
            console.log("initializeApp OK.");
            db = getFirestore(app);
            console.log("getFirestore OK.");
            // Habilita la red expl√≠citamente y luego marca como inicializado
            enableNetwork(db).then(() => {
                console.log("Red de Firestore habilitada expl√≠citamente.");
                firebaseInitialized = true; // MARCAR COMO LISTO AQU√ç
                console.log("Firebase inicializado y red habilitada.");
                document.dispatchEvent(new CustomEvent('firebaseReady')); // Avisar que est√° listo
            }).catch(error => {
                console.error("Error habilitando red de Firestore, se intentar√° operar offline:", error);
                // A√öN AS√ç MARCAR COMO INICIALIZADO para intentar funciones offline/cache
                firebaseInitialized = true;
                document.dispatchEvent(new CustomEvent('firebaseReady'));
            });
        } catch (error) {
            console.error("Error FATAL inicializando Firebase:", error);
            alert("Error CR√çTICO de configuraci√≥n de Firebase. La aplicaci√≥n no puede funcionar. Revisa la consola (F12).");
             showLoadingOverlay(false);
             // Dispara el evento igual para que DOMContentLoaded no se quede esperando
             document.dispatchEvent(new CustomEvent('firebaseReady'));
        }

        // =================================================================================
        // DEFINICI√ìN DE FUNCIONES GLOBALES
        // =================================================================================

        let currentAnimations = [];
        let animationsCollectionRef;

        // Espera a que Firebase est√© listo antes de definir la ref
        document.addEventListener('firebaseReady', () => {
            if (firebaseInitialized && db) {
                try {
                    animationsCollectionRef = collection(db, "animations");
                    console.log("Referencia a la colecci√≥n 'animations' creada POST firebaseReady.");
                } catch(e) {
                     console.error("Error creando referencia a la colecci√≥n POST firebaseReady:", e);
                     alert("Error creando referencia a la base de datos.");
                     firebaseInitialized = false; // Marcar como fallido si no se puede crear la ref
                }
            } else {
                 console.error("Evento firebaseReady disparado, pero DB no inicializada correctamente.");
                 firebaseInitialized = false; // Asegurar que est√© false si db fall√≥
            }
            // Llama a la inicializaci√≥n de la UI aqu√≠
            initializeUI();
        });


        async function initializeDatabase() { /* ... (Sin cambios respecto a V3) */ }
        function createAnimationCard(animation) { /* ... (Sin cambios) */ }
        function renderAllViews() { /* ... (Sin cambios) */ }
        function showSection(sectionName) { /* ... (Sin cambios) */ }
        function updateBreadcrumb(sectionName) { /* ... (Sin cambios) */ }
        function toggleMobileMenu() { /* ... (Sin cambios) */ }
        function loadAnimationById(animationId) { /* ... (Sin cambios) */ }
        function showLessonTab(tabName) { /* ... (Sin cambios) */ }
        function toggleFullscreen(id) { /* ... (Sin cambios) */ }
        function resetAnimation(id) { /* ... (Sin cambios) */ }
        function shareAnimation(animationId) { /* ... (Sin cambios) */ }
        function downloadNotes(animationId) { /* ... (Sin cambios) */ }
        function filterAnimations() { /* ... (Sin cambios) */ }
        function filterBySubject(subject, event) { /* ... (Sin cambios) */ }

        // --- toggleAdminPanel CORREGIDO ---
        function toggleAdminPanel() {
            console.log("toggleAdminPanel: Bot√≥n presionado."); // DEBUG
            console.log("toggleAdminPanel: firebaseInitialized =", firebaseInitialized); // DEBUG
            // Verifica si Firebase est√° REALMENTE listo antes de continuar
            if (!firebaseInitialized || !db || !animationsCollectionRef) {
                 alert("Firebase no est√° conectado o inicializado correctamente. No se puede abrir el panel.");
                 console.error("toggleAdminPanel: Intento de abrir panel pero Firebase no est√° listo (db o ref fall√≥)."); // DEBUG
                 return; // Detiene la ejecuci√≥n si Firebase fall√≥
            }
            const panel = document.getElementById('adminPanel');
            if (!panel) {
                console.error("toggleAdminPanel: Elemento 'adminPanel' no encontrado."); // DEBUG
                return;
            }
            panel.classList.toggle('hidden');
            console.log("toggleAdminPanel: Clase 'hidden' cambiada. Visible:", !panel.classList.contains('hidden')); // DEBUG
            if (!panel.classList.contains('hidden')) {
                 console.log("toggleAdminPanel: Panel visible, cargando animaciones existentes..."); // DEBUG
                 loadExistingAnimations(); // Carga desde Firestore
                 resetAdminForm(); // Asegura que el form est√© limpio al abrir
            }
        }

        function showAdminTab(tabName, event) { /* ... (Sin cambios) */ }
        async function loadExistingAnimations() { /* ... (Sin cambios) */ }
        function getGradientForSubject(s) { /* ... (Sin cambios) */ }
        function getColorForSubject(s) { /* ... (Sin cambios) */ }
        function resetAdminForm() { /* ... (Sin cambios) */ }
        async function deleteAnimation(animationId) { /* ... (Sin cambios) */ }
        function editAnimation(animationId) { /* ... (Sin cambios) */ }
        function loadSiteContent(contentData = {}) { /* ... (Sin cambios) */ }

        // =================================================================================
        // 7. INICIALIZACI√ìN DE LA P√ÅGINA Y LISTENER DEL FORMULARIO
        // =================================================================================

        // Funci√≥n separada para inicializar la UI despu√©s de que Firebase est√© listo
        async function initializeUI() {
            console.log("initializeUI: Iniciando..."); // DEBUG
            showLoadingOverlay(true, "Inicializando UI...");

            const savedContent = JSON.parse(localStorage.getItem('siteContent') || '{}');
            loadSiteContent(savedContent);

            // Solo inicializa DB y renderiza si Firebase est√° marcado como listo
            if (firebaseInitialized) {
                try {
                    await initializeDatabase(); // Carga inicial de datos
                    renderAllViews(); // Renderiza todo con los datos cargados
                } catch (e) { console.error("Error durante initializeUI:", e); }
                 finally { showLoadingOverlay(false); }
            } else {
                 console.warn("initializeUI: Firebase no inicializado. Renderizando vistas vac√≠as.");
                 renderAllViews(); // Renderizar vac√≠o o con mensaje de error si aplica
                 alert("No se pudo conectar con Firebase. Las animaciones no se cargar√°n.");
                 showLoadingOverlay(false);
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const animacionParaCargar = urlParams.get('animacion');
            if (animacionParaCargar) { loadAnimationById(animacionParaCargar); }
            else { showSection('inicio'); }
            
            const addAnimationForm = document.getElementById('addAnimationForm');
            if(addAnimationForm) {
                 // El listener del formulario se mantiene igual que en V3
                addAnimationForm.addEventListener('submit', async function(e) { /* ... (c√≥digo sin cambios) */ });
            } else { console.error("initializeUI: Formulario addAnimationForm no encontrado."); }
            
            console.log("initializeUI: Fin."); // DEBUG
        }

        // NO llames a initializeUI directamente aqu√≠, espera al evento 'firebaseReady'

        // Hacer funciones globales accesibles desde el HTML (onclick)
        window.showSection = showSection; window.toggleMobileMenu = toggleMobileMenu; window.loadAnimationById = loadAnimationById; window.showLessonTab = showLessonTab; window.toggleFullscreen = toggleFullscreen; window.resetAnimation = resetAnimation; window.shareAnimation = shareAnimation; window.downloadNotes = downloadNotes; window.filterAnimations = filterAnimations; window.filterBySubject = filterBySubject; window.toggleAdminPanel = toggleAdminPanel; window.showAdminTab = showAdminTab; window.editAnimation = editAnimation; window.deleteAnimation = deleteAnimation; window.resetAdminForm = resetAdminForm;

    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profe Digital Kwa - Plataforma Educativa Interactiva</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover, .card-hover:focus-within { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .animation-card { background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; }
        .section-hidden { display: none; }
        .lesson-tab { cursor: pointer; padding: 0.75rem 1.25rem; border-bottom: 3px solid transparent; font-weight: 600; color: #6b7280; }
        .lesson-tab:hover { color: #111827; }
        .lesson-tab.active { color: #4f46e5; border-bottom-color: #4f46e5; }
        .lesson-content { display: none; }
        .lesson-content.active { display: block; }
        #adminPanel form button[type="submit"]:disabled { background-color: #9ca3af; cursor: not-allowed;}
        /* Estilo para indicar carga */
        .loading-overlay { position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Overlay de Carga -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;"> <!-- Oculto por defecto -->
        <div class="loading-spinner"></div>
        <p class="ml-4 text-gray-700 font-semibold">Cargando datos...</p>
    </div>

    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="showSection('inicio')">
                    <div class="bg-white bg-opacity-20 p-2 rounded-lg"><span class="text-2xl">üìö</span></div>
                    <div><h1 class="text-2xl font-bold">Profe Digital Kwa</h1><p class="text-sm opacity-90">Plataforma Educativa Interactiva</p></div>
                </div>
                <nav class="hidden md:flex space-x-6 items-center">
                    <a href="#" onclick="event.preventDefault(); showSection('inicio')" class="hover:text-blue-200 transition-colors">Inicio</a>
                    <a href="#" onclick="event.preventDefault(); showSection('matematicas')" class="hover:text-blue-200 transition-colors">Matem√°ticas</a>
                    <a href="#" onclick="event.preventDefault(); showSection('fisica')" class="hover:text-blue-200 transition-colors">F√≠sica</a>
                    <a href="#" onclick="event.preventDefault(); showSection('animaciones')" class="bg-white bg-opacity-20 px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">Todas las Animaciones</a>
                </nav>
                <button class="md:hidden text-white" onclick="toggleMobileMenu()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
            </div>
            <div id="mobileMenu" class="hidden md:hidden mt-4 pb-4">
                <a href="#" onclick="event.preventDefault(); showSection('inicio')" class="block py-2 hover:text-blue-200">Inicio</a>
                <a href="#" onclick="event.preventDefault(); showSection('matematicas')" class="block py-2 hover:text-blue-200">Matem√°ticas</a>
                <a href="#" onclick="event.preventDefault(); showSection('fisica')" class="block py-2 hover:text-blue-200">F√≠sica</a>
                <a href="#" onclick="event.preventDefault(); showSection('animaciones')" class="block py-2 hover:text-blue-200">Todas las Animaciones</a>
            </div>
        </div>
    </header>
    <!-- Breadcrumb -->
    <nav id="breadcrumb" class="container mx-auto px-6 py-4" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center"><a href="#" onclick="event.preventDefault(); showSection('inicio')" class="text-gray-700 hover:text-blue-600">üè† Inicio</a></li>
            <li id="breadcrumbSection" class="hidden"><div class="flex items-center"><svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg><span id="breadcrumbText" class="ml-1 text-gray-500 md:ml-2"></span></div></li>
        </ol>
    </nav>
    <!-- Main Content -->
    <main class="container mx-auto px-6 pb-8">
        <section id="inicio" class="section"></section>
        <section id="matematicas" class="section section-hidden"></section>
        <section id="fisica" class="section section-hidden"></section>
        <section id="animaciones" class="section section-hidden"></section>
        <section id="animationDetail" class="section section-hidden"><div id="animationContent"></div></section>
    </main>
    <!-- Admin Panel Toggle -->
    <div id="adminToggle" class="fixed bottom-6 right-6 z-50"><button onclick="toggleAdminPanel()" class="bg-gray-800 hover:bg-gray-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 transform hover:scale-110" title="Panel de Administraci√≥n">üîë</button></div>
    <!-- Admin Panel Modal -->
    <div id="adminPanel" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col">
                <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-6 rounded-t-xl sticky top-0 z-10 flex-shrink-0"><div class="flex items-center justify-between"><div class="flex items-center space-x-3"><div class="bg-white bg-opacity-20 p-2 rounded-lg">üîë</div><div><h2 class="text-2xl font-bold">Panel de Administraci√≥n</h2><p class="text-gray-300">Gestiona contenido y animaciones (Firebase)</p></div></div><button onclick="toggleAdminPanel()" class="text-white hover:text-gray-300 text-2xl">‚úï</button></div></div>
                <div class="p-6 overflow-y-auto flex-grow">
                    <div class="flex border-b border-gray-200 mb-6"><button onclick="showAdminTab('animations', event)" class="admin-tab-btn px-6 py-3 font-semibold text-blue-600 border-b-2 border-blue-600">üé¨ Gestionar Animaciones</button></div>
                    <div id="adminAnimations" class="admin-tab-content">
                        <div class="mb-6"><h3 class="text-xl font-bold mb-4">Agregar/Editar Animaci√≥n</h3><form id="addAnimationForm" class="space-y-4"><input type="hidden" id="animationId"><div class="grid md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo</label><input type="text" id="animationTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ej: Teorema de Pit√°goras" required></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Materia</label><select id="animationSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"><option value="matematicas">üìê Matem√°ticas</option><option value="fisica">üî¨ F√≠sica</option><option value="quimica">‚öóÔ∏è Qu√≠mica</option></select></div></div><div><label class="block text-sm font-medium text-gray-700 mb-2">URL de la Animaci√≥n (iframe)</label><input type="url" id="animationUrl" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="https://fredykwa.github.io/..." required></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n Breve (para la tarjeta)</label><textarea id="animationDescription" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Descripci√≥n breve de la animaci√≥n" required></textarea></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Palabras Clave (separadas por espacios)</label><input type="text" id="animationKeywords" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="geometr√≠a tri√°ngulos teorema pit√°goras"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Objetivos de Aprendizaje (uno por l√≠nea)</label><textarea id="animationObjectives" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Comprender el teorema de Pit√°goras&#10;Aplicar la f√≥rmula en problemas"></textarea></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Controles Interactivos (uno por l√≠nea)</label><textarea id="animationControls" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ajusta los lados del tri√°ngulo&#10;Observa c√≥mo cambia la hipotenusa"></textarea></div><div class="border-t border-gray-200 pt-4"><label class="block text-sm font-medium text-gray-700 mb-2">Explicaci√≥n Te√≥rica (Acepta HTML)</label><textarea id="animationTheory" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="<p>Una fracci√≥n es un n√∫mero que...</p><ul><li>Numerador</li>...</ul>"></textarea></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Ejemplos Resueltos (Acepta HTML)</label><textarea id="animationExamples" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="<h4>Ejemplo 1:</h4><p>Si tenemos 3/4...</p>"></textarea></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Desaf√≠o (Acepta HTML)</label><textarea id="animationChallenge" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="<h4>¬°Ponte a prueba!</h4><p>¬øQu√© fracci√≥n es mayor, 2/3 o 5/6?</p>"></textarea></div><div class="flex space-x-4"><button type="submit" id="formSubmitButton" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">‚ûï Agregar Animaci√≥n</button><button type="button" id="formCancelButton" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors hidden" onclick="resetAdminForm()">Cancelar Edici√≥n</button></div></form></div>
                        <div class="border-t pt-6"><h3 class="text-xl font-bold mb-4">Animaciones Existentes (Firestore)</h3><div id="existingAnimations" class="space-y-4">Cargando...</div></div>
                    </div>
                    <!-- Pesta√±as de Content y Settings removidas temporalmente para simplificar -->
                </div>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-16">
        <div class="container mx-auto px-6 py-8">
            <div class="grid md:grid-cols-4 gap-8">
                <div><h4 class="text-lg font-semibold mb-4">Profe Digital Kwa</h4><p class="text-gray-400">Plataforma educativa interactiva para el aprendizaje de matem√°ticas y ciencias.</p></div>
                <div><h4 class="text-lg font-semibold mb-4">Materias</h4><ul class="space-y-2 text-gray-400"><li><a href="#" onclick="event.preventDefault(); showSection('matematicas')" class="hover:text-white">Matem√°ticas</a></li><li><a href="#" onclick="event.preventDefault(); showSection('fisica')" class="hover:text-white">F√≠sica</a></li><li><a href="#" class="hover:text-white">Qu√≠mica</a></li></ul></div>
                <div><h4 class="text-lg font-semibold mb-4">Recursos</h4><ul class="space-y-2 text-gray-400"><li><a href="#" onclick="event.preventDefault(); showSection('animaciones')" class="hover:text-white">Animaciones</a></li><li><a href="#" class="hover:text-white">Simuladores</a></li><li><a href="#" class="hover:text-white">Ejercicios</a></li></ul></div>
                <div><h4 class="text-lg font-semibold mb-4">Contacto</h4><ul id="footerContact" class="space-y-2 text-gray-400"><li>üìß info@eduhub.com</li><li>üì± +1 234 567 8900</li></ul></div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400"><p>&copy; 2024 Profe Digital Kwa. Todos los derechos reservados.</p></div>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        console.log("SCRIPT MODULE START: Iniciando script de m√≥dulo."); // DEBUG
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, setDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- Funci√≥n movida al principio ---
        function showLoadingOverlay(show, message = "Cargando...") {
            const overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                console.error("showLoadingOverlay: Elemento loadingOverlay no encontrado."); // DEBUG
                return;
            }
            const msgElement = overlay.querySelector('p');
            if (msgElement) msgElement.textContent = message;
            overlay.style.display = show ? 'flex' : 'none';
            console.log(`showLoadingOverlay: ${show ? 'Mostrando' : 'Ocultando'} - ${message}`); // DEBUG
        }

        // CONFIGURACI√ìN DE FIREBASE (PEGADA POR EL USUARIO Y CORREGIDA)
        const firebaseConfig = {
          apiKey: "AIzaSyBS5_0cPqCnbGo_chVNhZ-breB2GZu0OY8",
          authDomain: "profedigitalkwa.firebaseapp.com",
          projectId: "profedigitalkwa",
          storageBucket: "profedigitalkwa.appspot.com", // CORREGIDO
          messagingSenderId: "1045533291717",
          appId: "1:1045533291717:web:bac69b7e6f880855e6acac",
          measurementId: "G-GTG8N9354N"
        };

        // Initialize Firebase
        let app, db;
        let firebaseInitialized = false; // Flag para saber si Firebase inici√≥ bien
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            firebaseInitialized = true; // Marcar como inicializado
            console.log("Firebase inicializado correctamente con tu configuraci√≥n."); // DEBUG
        } catch (error) {
            console.error("Error FATAL inicializando Firebase:", error); // DEBUG
            alert("Error CR√çTICO de configuraci√≥n de Firebase. La aplicaci√≥n no puede funcionar. Revisa la consola (F12).");
             showLoadingOverlay(false); // Ocultar overlay si falla
        }

        // =================================================================================
        // DEFINICI√ìN DE FUNCIONES GLOBALES (ANTES DE LLAMARLAS)
        // =================================================================================

        let currentAnimations = []; // Variable global para el estado actual
        let animationsCollectionRef; // Referencia a la colecci√≥n en Firestore
        if (firebaseInitialized && db) { // Solo definir si Firebase inici√≥ bien
            animationsCollectionRef = collection(db, "animations");
        } else {
             console.error("La base de datos (db) no est√° inicializada. No se puede crear la referencia a la colecci√≥n.");
        }

        async function initializeDatabase() {
            if (!firebaseInitialized || !db) {
                console.error("initializeDatabase: Firebase no est√° inicializado. Abortando carga.");
                showLoadingOverlay(false);
                return [];
            }
            console.log("initializeDatabase: Leyendo datos de Firestore...");
            showLoadingOverlay(true, "Cargando animaciones...");
            try {
                const q = query(animationsCollectionRef, orderBy("title"));
                const querySnapshot = await getDocs(q);
                // Vac√≠a el array antes de llenarlo para evitar duplicados si se llama de nuevo
                currentAnimations = [];
                querySnapshot.forEach(docSnap => {
                    currentAnimations.push({ id: docSnap.id, ...docSnap.data() });
                });
                // Alternativa m√°s corta: currentAnimations = querySnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                console.log(`initializeDatabase: ${currentAnimations.length} animaciones cargadas.`);
            } catch (error) {
                console.error("Error obteniendo animaciones de Firestore:", error);
                alert(`Error al cargar las animaciones: ${error.message}. Revisa la consola y las reglas de seguridad.`);
                currentAnimations = [];
            } finally {
                 showLoadingOverlay(false);
            }
            return currentAnimations;
        }

        function createAnimationCard(animation) {
             const subjectIcons = { 'matematicas': 'üìê', 'fisica': '‚öõÔ∏è', 'quimica': '‚öóÔ∏è' };
             const subjectColors = { 'matematicas': { bg: 'bg-blue-500', grad: 'from-blue-100 to-blue-200' }, 'fisica': { bg: 'bg-purple-500', grad: 'from-purple-100 to-purple-200' }, 'quimica': { bg: 'bg-green-500', grad: 'from-green-100 to-green-200' }};
             const colors = subjectColors[animation.subject] || { bg: 'bg-gray-500', grad: 'from-gray-100 to-gray-200' };
             const icon = subjectIcons[animation.subject] || 'üß©';
             const animId = animation.id || `placeholder-${Math.random()}`;
             const thumbnailHTML = (animation.svgThumbnail && animation.svgThumbnail.startsWith('<svg')) ? animation.svgThumbnail : `<div class="text-6xl opacity-50">${icon}</div>`;
             const keywords = animation.keywords || '';
             return `<div class="animation-item animation-card rounded-xl overflow-hidden card-hover cursor-pointer aspect-square" data-subject="${animation.subject}" data-keywords="${keywords} ${animation.title}" role="button" tabindex="0" onclick="loadAnimationById('${animId}')" onkeydown="if(event.key==='Enter' || event.key===' ') { event.preventDefault(); loadAnimationById('${animId}'); }"><div class="h-3/5 bg-gradient-to-br ${colors.grad} relative overflow-hidden flex items-center justify-center">${thumbnailHTML}<div class="absolute top-3 right-3 ${colors.bg} text-white px-2 py-1 rounded-full text-xs font-semibold shadow-lg">${icon} ${animation.subject.charAt(0).toUpperCase() + animation.subject.slice(1)}</div></div><div class="h-2/5 p-4 flex flex-col justify-center"><h4 class="text-lg font-semibold mb-2 text-center">${animation.title}</h4><p class="text-gray-600 text-sm text-center leading-relaxed">${animation.description}</p></div></div>`;
        }

        function renderAllViews() {
            if (!firebaseInitialized) {
                console.warn("renderAllViews: Firebase no inicializado, saltando renderizado.");
                return;
            }
            console.log("renderAllViews: Iniciando renderizado...");
            const animationsToRender = currentAnimations; // Usa el estado global actualizado
            console.log("renderAllViews: Animaciones a renderizar:", animationsToRender.map(a => a.id));
            const inicioContainer = document.getElementById('inicio');
            const matematicasContainer = document.getElementById('matematicas');
            const fisicaContainer = document.getElementById('fisica');
            const todasContainer = document.getElementById('animaciones');

            if (!inicioContainer || !matematicasContainer || !fisicaContainer || !todasContainer) {
                 console.error("renderAllViews: No se encontraron todos los contenedores de secci√≥n.");
                 return;
            }

            const inicioHTML = `<div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8"><div class="gradient-bg text-white p-8 md:p-12"><h2 class="text-4xl md:text-5xl font-bold mb-4">Bienvenido a Profe Digital Kwa</h2><p class="text-xl text-blue-100 mb-6">Explora conceptos de matem√°ticas y f√≠sica a trav√©s de animaciones interactivas</p><div class="flex flex-wrap gap-4"><button onclick="showSection('matematicas')" class="bg-white text-indigo-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors">üìê Explorar Matem√°ticas</button><button onclick="showSection('fisica')" class="bg-indigo-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-600 transition-colors">üî¨ Explorar F√≠sica</button></div></div></div><div class="mb-8"><h3 class="text-2xl font-bold text-gray-800 mb-6">üåü Animaciones Destacadas</h3><div class="grid md:grid-cols-3 gap-6">${animationsToRender.filter(a => a.isFeatured).map(createAnimationCard).join('') || '<p class="text-gray-500 col-span-3">No hay animaciones destacadas.</p>'}</div></div><div class="grid md:grid-cols-4 gap-6 mb-8"><div class="bg-white rounded-lg p-6 text-center shadow-md"><div class="text-3xl font-bold text-blue-600 mb-2">${animationsToRender.length}</div><div class="text-gray-600">Animaciones</div></div><div class="bg-white rounded-lg p-6 text-center shadow-md"><div class="text-3xl font-bold text-green-600 mb-2">${[...new Set(animationsToRender.map(a => a.subject))].length}</div><div class="text-gray-600">Materias</div></div><div class="bg-white rounded-lg p-6 text-center shadow-md"><div class="text-3xl font-bold text-purple-600 mb-2">100%</div><div class="text-gray-600">Interactivo</div></div><div class="bg-white rounded-lg p-6 text-center shadow-md"><div class="text-3xl font-bold text-orange-600 mb-2">‚àû</div><div class="text-gray-600">Posibilidades</div></div></div>`;
            const matematicasHTML = `<div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8"><div class="bg-gradient-to-r from-blue-600 to-teal-600 text-white p-6"><h2 class="text-3xl font-bold mb-2">üìê Matem√°ticas</h2><p class="text-blue-100">Conceptos matem√°ticos visualizados de forma interactiva</p></div></div><div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">${animationsToRender.filter(a => a.subject === 'matematicas').map(createAnimationCard).join('') || '<p class="text-gray-500 col-span-3">No hay animaciones de matem√°ticas.</p>'}</div>`;
            const fisicaHTML = `<div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8"><div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6"><h2 class="text-3xl font-bold mb-2">üî¨ F√≠sica</h2><p class="text-indigo-100">Fen√≥menos f√≠sicos explicados a trav√©s de simulaciones</p></div></div><div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">${animationsToRender.filter(a => a.subject === 'fisica').map(createAnimationCard).join('') || '<p class="text-gray-500 col-span-3">No hay animaciones de f√≠sica.</p>'}</div>`;
            const todasHTML = `<div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8"><div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6"><h2 class="text-3xl font-bold mb-2">üé¨ Todas las Animaciones</h2><p class="text-green-100">Cat√°logo completo</p></div></div><div class="bg-white rounded-lg shadow-md p-6 mb-6"><div class="flex flex-col md:flex-row gap-4"><div class="flex-1"><input type="text" id="searchInput" placeholder="Buscar animaciones..." class="w-full px-4 py-2 border border-gray-300 rounded-lg" onkeyup="filterAnimations()"></div><div class="flex gap-2"><button onclick="filterBySubject('all', event)" class="filter-btn bg-blue-500 text-white px-4 py-2 rounded-lg">Todas</button><button onclick="filterBySubject('matematicas', event)" class="filter-btn bg-blue-100 text-blue-700 px-4 py-2 rounded-lg">Matem√°ticas</button><button onclick="filterBySubject('fisica', event)" class="filter-btn bg-purple-100 text-purple-700 px-4 py-2 rounded-lg">F√≠sica</button></div></div></div><div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="animationsGrid">${animationsToRender.map(createAnimationCard).join('') || '<p class="text-gray-500 col-span-3">A√∫n no hay animaciones.</p>'}</div>`;
            
            inicioContainer.innerHTML = inicioHTML;
            matematicasContainer.innerHTML = matematicasHTML;
            fisicaContainer.innerHTML = fisicaHTML;
            todasContainer.innerHTML = todasHTML;
             console.log("renderAllViews: Renderizado completado."); // DEBUG
        }
        
        function showSection(sectionName) {
            console.log(`showSection: Mostrando secci√≥n "${sectionName}"`); // DEBUG
            document.querySelectorAll('.section').forEach(s => s.classList.add('section-hidden'));
            const sectionElement = document.getElementById(sectionName);
            if (sectionElement) {
                 sectionElement.classList.remove('section-hidden');
            } else {
                console.error(`showSection: Secci√≥n con id "${sectionName}" no encontrada.`); // DEBUG
                const inicioEl = document.getElementById('inicio');
                if (inicioEl) inicioEl.classList.remove('section-hidden'); // Fallback to home
                sectionName = 'inicio';
            }
            updateBreadcrumb(sectionName);
            document.getElementById('mobileMenu')?.classList.add('hidden');
            window.scrollTo(0, 0);
        }

        function updateBreadcrumb(sectionName) {
            const breadcrumbSection = document.getElementById('breadcrumbSection');
            const breadcrumbText = document.getElementById('breadcrumbText');
            const sectionNames = { 'matematicas': 'Matem√°ticas', 'fisica': 'F√≠sica', 'animaciones': 'Todas las Animaciones', 'animationDetail': 'Detalle de Animaci√≥n' };
            if (!breadcrumbSection || !breadcrumbText) return;
            if (sectionName === 'inicio') { breadcrumbSection.classList.add('hidden'); }
            else { breadcrumbSection.classList.remove('hidden'); breadcrumbText.textContent = sectionNames[sectionName] || sectionName; }
        }

        function toggleMobileMenu() { document.getElementById('mobileMenu')?.classList.toggle('hidden'); }

        function loadAnimationById(animationId) {
             const animation = currentAnimations.find(a => a.id === animationId);
             if (!animation) { console.error('Animation not found:', animationId); alert('Error: Animaci√≥n no encontrada.'); showSection('inicio'); return; }
             const createListItems = (items = [], color = 'gray') => items.map(item => `<li class="flex items-start"><span class="text-${color}-500 mr-2">‚Ä¢</span>${item}</li>`).join('');
             const hasTheory = animation.theory && animation.theory.trim().length > 5, hasExamples = animation.examples && animation.examples.trim().length > 5, hasChallenge = animation.challenge && animation.challenge.trim().length > 5, hasLessonContent = hasTheory || hasExamples || hasChallenge;
             const animationColor = getColorForSubject(animation.subject);
             const animationGradient = getGradientForSubject(animation.subject);
             const content = `<div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8"><div class="bg-gradient-to-r ${animationGradient} text-white p-6"><h2 class="text-3xl font-bold mb-2">${animation.title}</h2><p class="text-${animationColor}-100">${animation.description}</p></div><div class="p-6"><div class="bg-gray-50 rounded-lg p-4 mb-6"><div class="flex items-center justify-between mb-4"><div class="flex items-center space-x-3"><div class="w-3 h-3 bg-red-500 rounded-full"></div><div class="w-3 h-3 bg-yellow-500 rounded-full"></div><div class="w-3 h-3 bg-green-500 rounded-full"></div><span class="text-sm text-gray-600 ml-4">Animaci√≥n Interactiva</span></div><button onclick="toggleFullscreen('${animation.id}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg">üì∫ Pantalla Completa</button></div><div id="animationContainer-${animation.id}" class="w-full bg-white rounded-lg shadow-inner aspect-video md:aspect-[16/9]"><iframe id="animationFrame-${animation.id}" src="${animation.url}" class="w-full h-full border-0 rounded-lg" title="${animation.title}" allowfullscreen></iframe></div></div><div class="grid md:grid-cols-2 gap-6 mb-8"><div class="bg-${animationColor}-50 p-6 rounded-lg"><h3 class="text-xl font-semibold text-${animationColor}-800 mb-3">üéØ Objetivos</h3><ul class="space-y-2 text-${animationColor}-700">${createListItems(animation.objectives, animationColor)}</ul></div><div class="bg-green-50 p-6 rounded-lg"><h3 class="text-xl font-semibold text-green-800 mb-3">üîß Controles</h3><ul class="space-y-2 text-green-700">${createListItems(animation.controls, 'green')}</ul></div></div>${hasLessonContent ? `<div class="bg-white rounded-xl shadow-lg overflow-hidden mt-8"><h3 class="text-2xl font-bold text-gray-800 p-6 border-b">Lecci√≥n Completa</h3><nav class="flex border-b">${hasTheory ? `<span id="tab-theory" class="lesson-tab active" onclick="showLessonTab('theory')">üìñ Explicaci√≥n</span>` : ''}${hasExamples ? `<span id="tab-examples" class="lesson-tab ${!hasTheory ? 'active' : ''}" onclick="showLessonTab('examples')">üí° Ejemplos</span>` : ''}${hasChallenge ? `<span id="tab-challenge" class="lesson-tab ${!hasTheory && !hasExamples ? 'active' : ''}" onclick="showLessonTab('challenge')">üß† Desaf√≠o</span>` : ''}</nav><div class="p-6 prose max-w-none prose-headings:font-semibold prose-a:text-blue-600 hover:prose-a:text-blue-800">${hasTheory ? `<div id="content-theory" class="lesson-content active">${animation.theory}</div>` : ''}${hasExamples ? `<div id="content-examples" class="lesson-content ${!hasTheory ? 'active' : ''}">${animation.examples}</div>` : ''}${hasChallenge ? `<div id="content-challenge" class="lesson-content ${!hasTheory && !hasExamples ? 'active' : ''}">${animation.challenge}</div>` : ''}</div></div>` : ''}<div class="flex flex-wrap gap-4 justify-center mt-12"><button onclick="resetAnimation('${animation.id}')" class="bg-orange-600 text-white px-6 py-3 rounded-lg flex items-center space-x-2"><span>üîÑ</span><span>Reiniciar</span></button><button onclick="shareAnimation('${animation.id}')" class="bg-green-600 text-white px-6 py-3 rounded-lg flex items-center space-x-2"><span>üì§</span><span>Compartir</span></button><button onclick="downloadNotes('${animation.id}')" class="bg-purple-600 text-white px-6 py-3 rounded-lg flex items-center space-x-2"><span>üìù</span><span>Descargar Resumen</span></button></div></div></div>`;
             document.getElementById('animationContent').innerHTML = content;
             showSection('animationDetail');
        }

        function showLessonTab(tabName) {
            document.querySelectorAll('#animationContent .lesson-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('#animationContent .lesson-tab').forEach(t => t.classList.remove('active'));
            const contentEl = document.getElementById(`content-${tabName}`);
            const tabEl = document.getElementById(`tab-${tabName}`);
            if(contentEl) contentEl.classList.add('active');
            if(tabEl) tabEl.classList.add('active');
        }

        function toggleFullscreen(id) {
            const elem = document.getElementById(`animationContainer-${id}`);
            if (!elem) return;
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => console.error(`Error entering fullscreen: ${err.message} (${err.name})`));
            } else {
                if (document.exitFullscreen) document.exitFullscreen().catch(err => console.error(`Error exiting fullscreen: ${err.message} (${err.name})`));
            }
        }
        function resetAnimation(id) { const iframe = document.getElementById(`animationFrame-${id}`); if (iframe) iframe.src = iframe.src; }
        
        function shareAnimation(animationId) {
            const animation = currentAnimations.find(a => a.id === animationId); // Usa estado global
            if (!animation) return;
            const shareURL = new URL(PORTAL_URL); shareURL.searchParams.set('animacion', animation.id);
            const urlString = shareURL.toString();
            if (navigator.share) { navigator.share({ title: `${animation.title} - Profe Digital Kwa`, text: 'Mira esta animaci√≥n educativa', url: urlString }); }
            else { navigator.clipboard.writeText(urlString).then(() => alert('¬°Enlace copiado al portapapeles!')); }
        }

        function downloadNotes(animationId) {
            const animation = currentAnimations.find(a => a.id === animationId); // Usa estado global
            if (!animation) return alert('No hay notas disponibles.');
            const stripHtml = (html) => { try { return new DOMParser().parseFromString(html, 'text/html').body.textContent || ""; } catch(e) { return html || ""; } };
            let content = `LECCI√ìN: ${animation.title.toUpperCase()}\n==================================\n\n`;
            if (animation.theory) content += `üìñ EXPLICACI√ìN TE√ìRICA\n----------------------\n${stripHtml(animation.theory)}\n\n`;
            if (animation.examples) content += `üí° EJEMPLOS RESUELTOS\n----------------------\n${stripHtml(animation.examples)}\n\n`;
            if (animation.challenge) content += `üß† DESAF√çO\n----------------------\n${stripHtml(animation.challenge)}\n\n`;
            const blob = new Blob([content + '---\nGenerado por Profe Digital Kwa'], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `${animation.id}-leccion.txt`; a.click();
            URL.revokeObjectURL(url);
        }

        function filterAnimations() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('#animationsGrid .animation-item').forEach(anim => { anim.style.display = anim.dataset.keywords.toLowerCase().includes(searchTerm) ? 'block' : 'none'; });
        }

        function filterBySubject(subject, event) {
            document.querySelectorAll('.filter-btn').forEach(btn => { btn.classList.remove('bg-blue-500', 'text-white', 'bg-purple-500'); btn.classList.add('bg-blue-100', 'text-blue-700'); });
            const activeClasses = subject === 'fisica' ? ['bg-purple-500', 'text-white'] : ['bg-blue-500', 'text-white'];
            event.target.classList.remove('bg-blue-100', 'text-blue-700');
            event.target.classList.add(...activeClasses);
            document.querySelectorAll('#animationsGrid .animation-item').forEach(anim => { anim.style.display = (subject === 'all' || anim.dataset.subject === subject) ? 'block' : 'none'; });
        }

        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                 loadExistingAnimations(); // Carga desde Firestore
                 resetAdminForm(); // Asegura que el form est√© limpio al abrir
            }
        }

        function showAdminTab(tabName, event) {
             document.querySelectorAll('.admin-tab-content').forEach(t => t.classList.add('hidden'));
             document.querySelectorAll('.admin-tab-btn').forEach(b => { b.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600'); b.classList.add('text-gray-500'); });
             const tabContent = document.getElementById(`admin${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
             if (tabContent) tabContent.classList.remove('hidden');
             if (event && event.target) {
                event.target.classList.remove('text-gray-500');
                event.target.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
             }
        }

        async function loadExistingAnimations() {
            const container = document.getElementById('existingAnimations');
            if (!container) return;
            container.innerHTML = '<div class="flex justify-center items-center p-4"><div class="loading-spinner"></div><span class="ml-2">Cargando...</span></div>';
            try {
                // Forzar relectura SIEMPRE al abrir el panel para m√°xima consistencia
                await initializeDatabase(); 

                container.innerHTML = currentAnimations.map(animation => `
                    <div class="bg-gray-100 p-4 rounded-lg flex items-center justify-between shadow-sm">
                        <div><h5 class="font-semibold">${animation.title}</h5><p class="text-sm text-gray-600">${animation.subject}</p></div>
                        <div class="flex space-x-2 flex-shrink-0">
                            <button onclick="editAnimation('${animation.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50">‚úèÔ∏è Editar</button>
                            <button onclick="deleteAnimation('${animation.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-50">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>`).join('') || '<p class="text-center text-gray-500">No hay animaciones en la base de datos.</p>';
            } catch (error) {
                console.error("Error loading existing animations for admin panel:", error); // DEBUG
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar animaciones.</p>';
            }
        }

        function getGradientForSubject(s) { return {matematicas:'from-blue-600 to-teal-600',fisica:'from-indigo-600 to-purple-600',quimica:'from-green-600 to-emerald-600'}[s] || 'from-gray-600 to-gray-700'; }
        function getColorForSubject(s) { return {matematicas:'blue',fisica:'indigo',quimica:'green'}[s] || 'gray'; }
        function resetAdminForm() { 
            const form = document.getElementById('addAnimationForm');
            if (form) form.reset(); 
            const animIdInput = document.getElementById('animationId');
            if (animIdInput) animIdInput.value = ''; 
            const submitBtn = document.getElementById('formSubmitButton');
            if (submitBtn) submitBtn.innerHTML = '‚ûï Agregar Animaci√≥n';
            const cancelBtn = document.getElementById('formCancelButton');
            if (cancelBtn) cancelBtn.classList.add('hidden'); 
        }

        async function deleteAnimation(animationId) {
            if (!firebaseInitialized || !db) { alert("Error: Firebase no est√° inicializado."); return; }
            const animationToDelete = currentAnimations.find(a => a.id === animationId);
            if (!animationToDelete) { alert("Error: No se encontr√≥ la animaci√≥n a eliminar."); return; }
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar la animaci√≥n "${animationToDelete.title}"?`)) return;

            console.log(`deleteAnimation: Intentando eliminar ${animationId} de Firestore.`); // DEBUG
            showLoadingOverlay(true, "Eliminando...");
            try {
                const animationDocRef = doc(db, "animations", animationId);
                await deleteDoc(animationDocRef);
                console.log(`deleteAnimation: Animaci√≥n ${animationId} eliminada de Firestore.`); // DEBUG
                
                await initializeDatabase(); // Recarga la lista global desde Firestore
                renderAllViews(); // Redibuja todas las vistas con la lista actualizada
                loadExistingAnimations(); // Actualiza la lista en el panel de admin
                
            } catch (error) {
                console.error("Error eliminando animaci√≥n de Firestore:", error); // DEBUG
                alert(`Error al eliminar la animaci√≥n: ${error.message}`);
            } finally {
                 showLoadingOverlay(false);
            }
        }

        function editAnimation(animationId) {
             const animationToEdit = currentAnimations.find(a => a.id === animationId); // Busca en el estado global
             if (!animationToEdit) { alert("Error: No se encontr√≥ la animaci√≥n para editar."); return; }
             
             // Llenar el formulario
             document.getElementById('animationId').value = animationToEdit.id;
             document.getElementById('animationTitle').value = animationToEdit.title;
             document.getElementById('animationSubject').value = animationToEdit.subject;
             document.getElementById('animationUrl').value = animationToEdit.url;
             document.getElementById('animationDescription').value = animationToEdit.description;
             document.getElementById('animationKeywords').value = animationToEdit.keywords || '';
             document.getElementById('animationObjectives').value = (animationToEdit.objectives || []).join('\n');
             document.getElementById('animationControls').value = (animationToEdit.controls || []).join('\n');
             document.getElementById('animationTheory').value = animationToEdit.theory || '';
             document.getElementById('animationExamples').value = animationToEdit.examples || '';
             document.getElementById('animationChallenge').value = animationToEdit.challenge || '';
             
             // Cambiar botones y enfocar
             document.getElementById('formSubmitButton').innerHTML = 'üíæ Actualizar Animaci√≥n';
             document.getElementById('formCancelButton').classList.remove('hidden');
             const adminPanel = document.getElementById('adminPanel');
             if (adminPanel) adminPanel.scrollTop = 0; // Sube al inicio del panel
             document.getElementById('animationTitle').focus();
        }
        
        function loadSiteContent(contentData) { /* (C√≥digo sin cambios) */ }

        // =================================================================================
        // 7. INICIALIZACI√ìN DE LA P√ÅGINA
        // =================================================================================

        document.addEventListener('DOMContentLoaded', async function() {
            console.log("DOMContentLoaded: Evento disparado."); // DEBUG

             // Ocultar overlay al inicio, se mostrar√° en initializeDatabase si es necesario
             showLoadingOverlay(false);

            // Carga contenido est√°tico como t√≠tulo y footer
            const savedContent = JSON.parse(localStorage.getItem('siteContent') || '{}');
            loadSiteContent(savedContent);

            // Inicializa la base de datos (lee de Firestore) y luego renderiza
            if (firebaseInitialized) { // Solo intentar si Firebase inici√≥ bien
                try {
                    await initializeDatabase(); // Carga inicial de datos
                    renderAllViews(); // Renderiza todo con los datos cargados
                } catch (e) {
                    console.error("Error durante la inicializaci√≥n de datos/renderizado:", e); // DEBUG
                } finally {
                     // Asegurarse de ocultar el overlay despu√©s de la carga inicial
                     showLoadingOverlay(false);
                }
            } else {
                 // Si Firebase no inici√≥, al menos intenta renderizar algo vac√≠o o un mensaje
                 console.warn("DOMContentLoaded: Firebase no inicializado, renderizando vistas vac√≠as.");
                 renderAllViews(); // Intentar√° renderizar (probablemente vac√≠o por `currentAnimations = []`)
                 alert("No se pudo conectar con Firebase. Las animaciones no se cargar√°n.");
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const animacionParaCargar = urlParams.get('animacion');
            if (animacionParaCargar) {
                // Intenta cargar la animaci√≥n incluso si la carga inicial fall√≥ (podr√≠a estar en cach√© o cargar despu√©s)
                loadAnimationById(animacionParaCargar);
            } else {
                showSection('inicio');
            }
            
            // Configurar el listener para el formulario de admin
            const addAnimationForm = document.getElementById('addAnimationForm');
            if(addAnimationForm) {
                addAnimationForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                     if (!firebaseInitialized || !db) { alert("Error: Firebase no est√° conectado."); return; } 
                    console.log("Form Submit: Evento detectado."); // DEBUG
                    const submitButton = document.getElementById('formSubmitButton');
                    submitButton.disabled = true;
                    showLoadingOverlay(true, "Guardando...");

                    const editingId = document.getElementById('animationId').value;
                    const subject = document.getElementById('animationSubject').value;
                    // Prepara los datos del formulario para Firestore
                    const animationData = { 
                        title: document.getElementById('animationTitle').value, subject: subject,
                        url: document.getElementById('animationUrl').value, description: document.getElementById('animationDescription').value,
                        keywords: document.getElementById('animationKeywords').value || '',
                        objectives: document.getElementById('animationObjectives').value.split('\n').filter(t => t.trim()),
                        controls: document.getElementById('animationControls').value.split('\n').filter(t => t.trim()),
                        gradient: getGradientForSubject(subject), color: getColorForSubject(subject), 
                        isFeatured: true, // Hacer que las nuevas aparezcan destacadas por defecto
                        theory: document.getElementById('animationTheory').value || '',
                        examples: document.getElementById('animationExamples').value || '',
                        challenge: document.getElementById('animationChallenge').value || ''
                    };
                     console.log("Form Submit: Datos a guardar:", animationData); // DEBUG
                    
                    try {
                        if (editingId) { // MODO EDICI√ìN
                            console.log(`Form Submit: Actualizando ${editingId} en Firestore.`); // DEBUG
                            const animationDocRef = doc(db, "animations", editingId);
                            await setDoc(animationDocRef, animationData, { merge: true }); 
                            alert('¬°Animaci√≥n actualizada exitosamente!');
                        } else { // MODO AGREGAR
                            console.log("Form Submit: Agregando nueva animaci√≥n a Firestore."); // DEBUG
                            const docRef = await addDoc(animationsCollectionRef, animationData);
                            console.log("Form Submit: Documento agregado con ID: ", docRef.id); // DEBUG
                            alert('¬°Animaci√≥n agregada exitosamente!');
                        }
                        
                        // Despu√©s de guardar, recarga TODO desde Firestore y redibuja
                        await initializeDatabase(); 
                        renderAllViews(); 
                        resetAdminForm();
                        loadExistingAnimations(); // Actualiza la lista en admin
                        
                    } catch (error) {
                        console.error("Error guardando animaci√≥n en Firestore:", error); // DEBUG
                        alert(`Error al guardar la animaci√≥n: ${error.message}. Revisa la consola y las reglas de seguridad.`);
                    } finally {
                        submitButton.disabled = false;
                        showLoadingOverlay(false);
                    }
                });
            } else {
                 console.error("DOMContentLoaded: Formulario addAnimationForm no encontrado."); // DEBUG
            }
            
            console.log("DOMContentLoaded: Fin de la inicializaci√≥n."); // DEBUG
        }); // Fin DOMContentLoaded

        // Hacer funciones globales accesibles desde el HTML (onclick)
        window.showSection = showSection;
        window.toggleMobileMenu = toggleMobileMenu;
        window.loadAnimationById = loadAnimationById;
        window.showLessonTab = showLessonTab;
        window.toggleFullscreen = toggleFullscreen;
        window.resetAnimation = resetAnimation;
        window.shareAnimation = shareAnimation;
        window.downloadNotes = downloadNotes;
        window.filterAnimations = filterAnimations;
        window.filterBySubject = filterBySubject;
        window.toggleAdminPanel = toggleAdminPanel;
        window.showAdminTab = showAdminTab;
        window.editAnimation = editAnimation;
        window.deleteAnimation = deleteAnimation;
        window.resetAdminForm = resetAdminForm;

    </script>
</body>
</html>

